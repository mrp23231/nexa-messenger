{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - Nexa Messenger{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-shield-alt"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ total_users }}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon online">
                <i class="fas fa-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ online_users }}</div>
                <div class="stat-label">–û–Ω–ª–∞–π–Ω</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-hashtag"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ total_channels }}</div>
                <div class="stat-label">–ö–∞–Ω–∞–ª–æ–≤</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ total_messages }}</div>
                <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon banned">
                <i class="fas fa-ban"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ banned_users }}</div>
                <div class="stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon reports">
                <i class="fas fa-flag"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ pending_reports }}</div>
                <div class="stat-label">–ñ–∞–ª–æ–±</div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="charts-section">
        <div class="chart-container">
            <h3><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 30 –¥–Ω–µ–π</h3>
            <canvas id="statsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="recent-section">
        <h3><i class="fas fa-user-plus"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h3>
        <div class="users-grid">
            {% for user in recent_users %}
            <div class="user-card">
                <div class="user-avatar">
                    {% if user.profile_picture and user.profile_picture != 'default.jpg' %}
                        <img src="{{ url_for('static', filename='uploads/' + user.profile_picture) }}" alt="Avatar">
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                    <span class="status-indicator {% if user.is_online %}online{% else %}offline{% endif %}"></span>
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.display_name }}</div>
                    <div class="user-username">@{{ user.username }}</div>
                    <div class="user-email">{{ user.email }}</div>
                    <div class="user-joined">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {{ user.created_at.strftime('%d.%m.%Y') }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã -->
    <div class="channels-section">
        <h3><i class="fas fa-fire"></i> –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã</h3>
        <div class="channels-grid">
            {% for channel in active_channels %}
            <div class="channel-card">
                <div class="channel-header">
                    <div class="channel-icon">
                        <i class="fas fa-hashtag"></i>
                    </div>
                    <div class="channel-info">
                        <h4>{{ channel.name }}</h4>
                        <p>{{ channel.description }}</p>
                        <div class="channel-meta">
                            <span class="member-count">
                                <i class="fas fa-users"></i> {{ channel.member_count }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∂–∞–ª–æ–±—ã -->
    <div class="reports-section">
        <h3><i class="fas fa-flag"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∂–∞–ª–æ–±—ã</h3>
        <div class="reports-grid">
            {% for report in recent_reports %}
            <div class="report-card">
                <div class="report-header">
                    <div class="report-status {{ report.status }}">
                        <i class="fas fa-flag"></i>
                        {{ report.status }}
                    </div>
                    <div class="report-time">{{ report.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                </div>
                <div class="report-content">
                    <div class="report-users">
                        <span class="reporter">–û—Ç: @{{ report.reporter.username }}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="reported">–ù–∞: @{{ report.reported_user.username }}</span>
                    </div>
                    <div class="report-reason">
                        <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ report.reason }}
                    </div>
                    {% if report.description %}
                    <div class="report-description">
                        <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ report.description }}
                    </div>
                    {% endif %}
                    {% if report.evidence %}
                    <div class="report-evidence">
                        <strong>–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:</strong> {{ report.evidence }}
                    </div>
                    {% endif %}
                </div>
                <div class="report-actions">
                    <button class="btn btn-sm btn-primary" onclick="viewReport({{ report.id }})">
                        <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="reports-actions">
            <a href="/admin/reports" class="btn btn-primary">
                <i class="fas fa-list"></i> –í—Å–µ –∂–∞–ª–æ–±—ã
            </a>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
    <div class="users-management-section">
        <h3><i class="fas fa-cogs"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
        
        <div class="search-controls">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." class="search-input">
            </div>
            <button class="btn btn-primary" onclick="loadUsers()">
                <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
            </button>
        </div>
        
        <div class="users-table-container">
            <table class="users-table" id="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ê–≤–∞—Ç–∞—Ä</th>
                        <th>–ò–º—è</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–û–Ω–ª–∞–π–Ω</th>
                        <th>–ê–¥–º–∏–Ω</th>
                        <th>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞</th>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        <th>–ñ–∞–ª–æ–±—ã</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
            
            <div class="pagination" id="pagination">
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal" id="user-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
            <button class="close-btn" onclick="closeUserModal()">&times;</button>
        </div>
        <div class="modal-body" id="user-modal-body">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∂–∞–ª–æ–±—ã -->
<div class="modal" id="report-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üö© –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="close-btn" onclick="closeReportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="report-form">
                <input type="hidden" id="report-user-id">
                <div class="form-group">
                    <label>–ù–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <strong id="report-username"></strong></label>
                </div>
                
                <div class="form-group">
                    <label for="report-reason">–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã *</label>
                    <select id="report-reason" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
                        <option value="–°–ø–∞–º –∏ —Ä–µ–∫–ª–∞–º–∞">–°–ø–∞–º –∏ —Ä–µ–∫–ª–∞–º–∞</option>
                        <option value="–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è">–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è</option>
                        <option value="–°–ø–∞–º">–°–ø–∞–º</option>
                        <option value="–ù–µ–ø—Ä–∏–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç">–ù–µ–ø—Ä–∏–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</option>
                        <option value="–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ">–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ</option>
                        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="report-description">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è *</label>
                    <textarea id="report-description" rows="4" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="report-evidence">–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="report-evidence" rows="3" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ç.–¥."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeReportModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-warning" onclick="submitReport()">
                        üö© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π -->
<div class="modal" id="warn-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ö†Ô∏è –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</h3>
            <button class="close-btn" onclick="closeWarnModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="warn-form">
                <input type="hidden" id="warn-user-id">
                <div class="form-group">
                    <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="warn-username"></strong></label>
                </div>
                <div class="form-group">
                    <label for="warn-reason">–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è *</label>
                    <textarea id="warn-reason" rows="4" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeWarnModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-warning" onclick="submitWarn()">
                        ‚ö†Ô∏è –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -->
<div class="modal" id="ban-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="close-btn" onclick="closeBanModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="ban-form">
                <input type="hidden" id="ban-user-id">
                <div class="form-group">
                    <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="ban-username"></strong></label>
                </div>
                <div class="form-group">
                    <label for="ban-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ *</label>
                    <select id="ban-duration" required>
                        <option value="60">1 —á–∞—Å</option>
                        <option value="1440">1 –¥–µ–Ω—å</option>
                        <option value="10080">1 –Ω–µ–¥–µ–ª—è</option>
                        <option value="43200">1 –º–µ—Å—è—Ü</option>
                        <option value="216000">5 –º–µ—Å—è—Ü–µ–≤</option>
                        <option value="0">–ù–∞–≤—Å–µ–≥–¥–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ban-reason">–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ *</label>
                    <textarea id="ban-reason" rows="4" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBanModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-danger" onclick="submitBan()">
                        üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentPage = 1;
let totalPages = 1;

document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    loadStatistics();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    loadUsers();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫
    initChart();
});

function loadStatistics() {
    fetch('/admin/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                showError(data.message);
                return;
            }
            
            updateChart(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        });
}

function loadUsers(page = 1) {
    const search = document.getElementById('user-search').value;
    
    fetch(`/admin/users?page=${page}&search=${encodeURIComponent(search)}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                showError(data.message);
                return;
            }
            
            displayUsers(data.users);
            updatePagination(data.current_page, data.pages, data.total);
            currentPage = data.current_page;
            totalPages = data.pages;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        });
}

function displayUsers(users) {
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>#${user.id}</strong></td>
            <td>
                <div class="user-avatar-small" onclick="viewUserProfile('${user.username}')" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                    ${user.profile_picture && user.profile_picture !== 'default.jpg' 
                        ? `<img src="/static/uploads/${user.profile_picture}" alt="Avatar">` 
                        : '<i class="fas fa-user"></i>'}
                    <span class="status-indicator ${user.is_online ? 'online' : 'offline'}"></span>
                </div>
            </td>
            <td>${user.display_name}</td>
            <td>@${user.username}</td>
            <td>${user.email}</td>
            <td>
                <span class="status-badge ${user.status}">
                    ${getStatusText(user.status)} ${user.custom_status ? `(${user.custom_status})` : ''}
                </span>
            </td>
            <td>
                <span class="online-indicator ${user.is_online ? 'online' : 'offline'}">
                    ${user.is_online ? 'üü¢' : '‚ö´'}
                </span>
            </td>
            <td>
                <span class="admin-badge ${user.is_admin ? 'admin' : 'user'}">
                    ${user.is_admin ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                </span>
            </td>
            <td>
                ${user.is_banned ? 
                    `<span class="ban-badge">
                        üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω<br>
                        <small>${user.ban_reason}</small>
                        ${user.ban_until ? `<br><small>–î–æ: ${user.ban_until}</small>` : '<br><small>–ù–∞–≤—Å–µ–≥–¥–∞</small>'}
                    </span>` : 
                    '<span class="status-ok">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>'
                }
            </td>
            <td>${user.created_at}</td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="viewUser(${user.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="toggleAdmin(${user.id})">
                    <i class="fas fa-shield-alt"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="warnUser(${user.id}, '${user.username}')" title="–í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ">
                    ‚ö†Ô∏è
                </button>
                ${user.is_banned ? 
                    `<button class="btn btn-sm btn-success" onclick="unbanUser(${user.id})">
                        <i class="fas fa-unlock"></i>
                    </button>` : 
                    `<button class="btn btn-sm btn-danger" onclick="banUser(${user.id})">
                        <i class="fas fa-ban"></i>
                    </button>`
                }
                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="reportUser(${user.id}, '${user.username}')">
                    üö© –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updatePagination(currentPage, totalPages, totalUsers) {
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '<div class="pagination-info">';
    html += `–ü–æ–∫–∞–∑–∞–Ω–æ ${((currentPage - 1) * 20) + 1}-${Math.min(currentPage * 20, totalUsers)} –∏–∑ ${totalUsers}`;
    html += '</div>';
    
    html += '<div class="pagination-controls">';
    
    if (currentPage > 1) {
        html += `<button class="btn btn-sm" onclick="loadUsers(${currentPage - 1})">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>`;
    }
    
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<button class="btn btn-sm ${i === currentPage ? 'btn-primary' : ''}" onclick="loadUsers(${i})">${i}</button>`;
    }
    
    if (currentPage < totalPages) {
        html += `<button class="btn btn-sm" onclick="loadUsers(${currentPage + 1})">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>`;
    }
    
    html += '</div>';
    pagination.innerHTML = html;
}

function getStatusText(status) {
    const statusMap = {
        'online': 'üü¢ –í —Å–µ—Ç–∏',
        'away': 'üü° –û—Ç–æ—à–µ–ª',
        'busy': 'üî¥ –ó–∞–Ω—è—Ç',
        'dnd': 'üö´ –ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å'
    };
    return statusMap[status] || status;
}

function viewUser(userId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    showInfo('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function toggleAdmin(userId) {
    if (confirm('–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
        fetch(`/api/user/${userId}/toggle_admin`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showInfo(data.message);
                loadUsers(currentPage); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤');
        });
    }
}

function banUser(userId) {
    const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:');
    if (!reason) return;
    
    const duration = prompt('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö (0 = –Ω–∞–≤—Å–µ–≥–¥–∞):');
    if (duration === null) return;
    
    const durationNum = parseInt(duration) || 0;
    
    fetch(`/api/user/${userId}/ban`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason,
            duration: durationNum
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showInfo(data.message);
            loadUsers(currentPage);
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ');
    });
}

function unbanUser(userId) {
    if (confirm('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
        fetch(`/api/user/${userId}/unban`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showInfo(data.message);
                loadUsers(currentPage);
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ');
        });
    }
}

function deleteUser(userId) {
    if (confirm('–£–î–ê–õ–ò–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        fetch(`/api/user/${userId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showInfo(data.message);
                loadUsers(currentPage);
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        });
    }
}

function viewReport(reportId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –∂–∞–ª–æ–±—ã
    showInfo('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∂–∞–ª–æ–±—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

function initChart() {
    const ctx = document.getElementById('statsChart').getContext('2d');
    window.statsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                data: [],
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                tension: 0.4
            }, {
                label: '–°–æ–æ–±—â–µ–Ω–∏—è',
                data: [],
                borderColor: '#ff6b9d',
                backgroundColor: 'rgba(255, 107, 157, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateChart(data) {
    if (window.statsChart) {
        window.statsChart.data.labels = data.dates;
        window.statsChart.data.datasets[0].data = data.user_counts;
        window.statsChart.data.datasets[1].data = data.message_counts;
        window.statsChart.update();
    }
}

function closeUserModal() {
    document.getElementById('user-modal').style.display = 'none';
}

function reportUser(userId, username) {
    document.getElementById('report-user-id').value = userId;
    document.getElementById('report-username').textContent = username;
    document.getElementById('report-modal').style.display = 'block';
}

function viewUserProfile(username) {
    window.open(`/profile/${username}`, '_blank');
}

function closeReportModal() {
    document.getElementById('report-modal').style.display = 'none';
}

function warnUser(userId, username) {
    document.getElementById('warn-user-id').value = userId;
    document.getElementById('warn-username').textContent = username;
    document.getElementById('warn-modal').style.display = 'block';
}

function closeWarnModal() {
    document.getElementById('warn-modal').style.display = 'none';
}

function banUser(userId, username) {
    document.getElementById('ban-user-id').value = userId;
    document.getElementById('ban-username').textContent = username;
    document.getElementById('ban-modal').style.display = 'block';
}

function closeBanModal() {
    document.getElementById('ban-modal').style.display = 'none';
}

function submitReport() {
    const userId = document.getElementById('report-user-id').value;
    const reason = document.getElementById('report-reason').value;
    const description = document.getElementById('report-description').value;
    const evidence = document.getElementById('report-evidence').value;
    
    if (!reason || !description) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ');
        return;
    }
    
    const reportData = {
        reported_user_id: userId,
        reason: reason,
        description: description,
        evidence: evidence
    };
    
    fetch('/api/report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showInfo('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
            closeReportModal();
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('report-reason').value = '';
            document.getElementById('report-description').value = '';
            document.getElementById('report-evidence').value = '';
        } else {
            showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã');
    });
}

function submitWarn() {
    const userId = document.getElementById('warn-user-id').value;
    const reason = document.getElementById('warn-reason').value;
    
    if (!reason) {
        showError('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è');
        return;
    }
    
    fetch(`/api/user/${userId}/warn`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message);
            closeWarnModal();
            loadUsers(currentPage); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è');
    });
}

function submitBan() {
    const userId = document.getElementById('ban-user-id').value;
    const duration = parseInt(document.getElementById('ban-duration').value);
    const reason = document.getElementById('ban-reason').value;
    
    if (!reason) {
        showError('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
        return;
    }
    
    fetch(`/api/user/${userId}/ban`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason,
            duration: duration
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(data.message);
            closeBanModal();
            loadUsers(currentPage); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        });
}

// –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
document.getElementById('user-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        loadUsers(1);
    }
});
</script>
{% endblock %}

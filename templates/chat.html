{% extends "base.html" %}

{% block title %}–ß–∞—Ç - –û–Ω–ª–∞–π–Ω –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." class="search-input">
                    <button id="clear-search" class="clear-search-btn" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="users-list" id="users-list">
            {% for user in users %}
            <div class="user-item" data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                <div class="user-avatar" onclick="viewUserProfile('{{ user.username }}')" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å {{ user.username }}">
                    <i class="fas fa-user"></i>
                    <span class="status-indicator {% if user.is_online %}online{% else %}offline{% endif %}"></span>
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.username }}</div>
                    <div class="user-status">
                        {% if user.is_online %}
                            <span class="status-text online">–í —Å–µ—Ç–∏</span>
                        {% else %}
                            <span class="status-text offline">–ù–µ –≤ —Å–µ—Ç–∏</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="chat-main">
        <div class="chat-header">
            <button class="sidebar-toggle" id="sidebar-toggle" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
            <div class="chat-user-info">
                <i class="fas fa-user"></i>
                <span id="current-chat-user">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞</span>
                <div id="typing-indicator" class="typing-indicator" style="display: none;">
                    <span class="typing-text">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <div class="welcome-message">
                <i class="fas fa-comments"></i>
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
        </div>
        
        <div class="chat-input-container">
            <form id="message-form" class="message-form">
                <div class="message-input-wrapper">
                    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <div class="message-actions">
                        <button type="button" class="emoji-btn" onclick="toggleEmojiPicker()">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button type="button" class="reply-btn" onclick="cancelReply()" style="display: none;">
                            <i class="fas fa-reply"></i> –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
                        </button>
                    </div>
                </div>
                <button type="submit" id="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
            <div id="reply-preview" style="display: none;">
                <div class="reply-preview-content">
                    <span class="reply-label">–û—Ç–≤–µ—Ç –Ω–∞:</span>
                    <span class="reply-text" id="reply-text"></span>
                    <button type="button" onclick="cancelReply()" class="cancel-reply-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –≠–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä -->
        <div class="emoji-picker" id="emoji-picker" style="display: none;">
            <div class="emoji-picker-header">
                <span>–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏</span>
                <button type="button" onclick="toggleEmojiPicker()" class="close-emoji-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="emoji-grid">
                <button type="button" class="emoji-btn" onclick="addEmoji('üòÄ')">üòÄ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üòÉ')">üòÉ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üòÑ')">üòÑ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üòÅ')">üòÅ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üòÜ')">üòÜ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üòÖ')">üòÖ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üòÇ')">üòÇ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('ü§£')">ü§£</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üíô')">üíô</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üíö')">üíö</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üíõ')">üíõ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üíú')">üíú</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üíñ')">üíñ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üëç')">üëç</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üëé')">üëé</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üëè')">üëè</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üôå')">üôå</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üéâ')">üéâ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üî•')">üî•</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('üíØ')">üíØ</button>
                <button type="button" class="emoji-btn" onclick="addEmoji('‚ú®')">‚ú®</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentChatUserId = null;
    let socket = null;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
    document.addEventListener('DOMContentLoaded', function() {
        socket = io();
        
        socket.on('connect', function() {
            console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
        });
        
        socket.on('new_message', function(data) {
            if (data.sender_id === currentChatUserId || data.receiver_id === currentChatUserId) {
                displayMessage(data);
            }
        });
        
        socket.on('user_status', function(data) {
            updateUserStatus(data.user_id, data.status);
        });
        
        socket.on('typing_start', function(data) {
            if (data.user_id === currentChatUserId) {
                showTypingIndicator();
            }
        });
        
        socket.on('typing_stop', function(data) {
            if (data.user_id === currentChatUserId) {
                hideTypingIndicator();
            }
        });
        
        socket.on('message_notification', function(data) {
            showMessageNotification(data);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        setupUserSearch();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
        setupTypingIndicator();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
        setupMobileMenu();
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        requestNotificationPermission();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const username = this.dataset.username;
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            document.querySelectorAll('.user-item').forEach(u => u.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            this.classList.add('active');
            
            currentChatUserId = userId;
            document.getElementById('current-chat-user').textContent = username;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages(userId);
        });
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function loadMessages(userId) {
        fetch(`/api/messages/${userId}`)
            .then(response => response.json())
            .then(messages => {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä –ø–µ—Ä–≤—ã–º!</div>';
                } else {
                    messages.forEach(message => {
                        displayMessage(message);
                    });
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function displayMessage(message) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.is_own ? 'own' : 'other'}`;
        messageDiv.dataset.messageId = message.id;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        const senderName = message.is_own ? '–í—ã' : (message.sender_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        
        // HTML –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        let replyHtml = '';
        if (message.reply_to_id && message.reply_to_content) {
            replyHtml = `
                <div class="message-reply">
                    <i class="fas fa-reply"></i>
                    <span>${message.reply_to_content}</span>
                </div>
            `;
        }
        
        // HTML –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let editedHtml = '';
        if (message.is_edited) {
            editedHtml = '<span class="edited-indicator">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';
        }
        
        // HTML –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π
        let reactionsHtml = '';
        if (message.reactions && message.reactions.length > 0) {
            const uniqueReactions = [...new Set(message.reactions.map(r => r.emoji))];
            reactionsHtml = `
                <div class="message-reactions">
                    ${uniqueReactions.map(emoji => {
                        const count = message.reactions.filter(r => r.emoji === emoji).length;
                        return `<span class="reaction" onclick="addReaction(${message.id}, '${emoji}')">${emoji} ${count}</span>`;
                    }).join('')}
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="message-content">
                ${!message.is_own ? `
                    <div class="message-sender">
                        <div class="sender-avatar" onclick="viewUserProfile('${message.sender_username}')" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                            <i class="fas fa-user"></i>
                        </div>
                        <span>${senderName}</span>
                    </div>
                ` : ''}
                ${replyHtml}
                <div class="message-text">${message.content}</div>
                <div class="message-footer">
                    <span class="message-time">${message.timestamp}</span>
                    ${editedHtml}
                </div>
                ${reactionsHtml}
                <div class="message-actions">
                    <button type="button" class="action-btn" onclick="replyToMessage(${message.id}, '${message.content}')">
                        <i class="fas fa-reply"></i>
                    </button>
                    <button type="button" class="action-btn" onclick="showReactions(${message.id})">
                        <i class="fas fa-smile"></i>
                    </button>
                    ${!message.is_own ? `
                        <button type="button" class="action-btn" onclick="viewUserProfile('${message.sender_username}')" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                            <i class="fas fa-user"></i>
                        </button>
                        <button type="button" class="action-btn" onclick="reportUserFromChat(${message.id}, '${message.sender_username}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è">
                            üö©
                        </button>
                    ` : ''}
                    ${message.is_own ? `
                        <button type="button" class="action-btn" onclick="editMessage(${message.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="action-btn" onclick="deleteMessage(${message.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        
        // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(10px)';
        setTimeout(() => {
            messageDiv.style.transition = 'all 0.3s ease';
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 50);
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (message && currentChatUserId) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
            socket.emit('send_message', {
                receiver_id: currentChatUserId,
                content: message
            });
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function updateUserStatus(userId, status) {
        const userItem = document.querySelector(`[data-user-id="${userId}"]`);
        if (userItem) {
            const statusIndicator = userItem.querySelector('.status-indicator');
            const statusText = userItem.querySelector('.status-text');
            
            statusIndicator.className = `status-indicator ${status}`;
            statusText.className = `status-text ${status}`;
            statusText.textContent = status === 'online' ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏';
        }
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function setupUserSearch() {
        const searchInput = document.getElementById('user-search');
        const clearButton = document.getElementById('clear-search');
        const usersList = document.getElementById('users-list');
        
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (clearButton) {
                clearButton.style.display = query ? 'block' : 'none';
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchUsers(query);
            }, 300);
        });
        
        if (clearButton) {
            clearButton.addEventListener('click', function() {
                searchInput.value = '';
                this.style.display = 'none';
                searchUsers('');
            });
        }
    }
    
    function searchUsers(query) {
        fetch(`/search_users?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(users => {
                updateUsersList(users);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            });
    }
    
    function updateUsersList(users) {
        const usersList = document.getElementById('users-list');
        usersList.innerHTML = '';
        
        if (users.length === 0) {
            usersList.innerHTML = '<div class="no-users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }
        
        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            userDiv.dataset.userId = user.id;
            userDiv.dataset.username = user.username;
            
            userDiv.innerHTML = `
                <div class="user-avatar" onclick="viewUserProfile('${user.username}')" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                    <i class="fas fa-user"></i>
                    <span class="status-indicator ${user.is_online ? 'online' : 'offline'}"></span>
                </div>
                <div class="user-info">
                    <div class="user-name">${user.display_name || user.username}</div>
                    <div class="user-username">@${user.username}</div>
                    <div class="user-status">
                        <span class="status-text ${user.is_online ? 'online' : 'offline'}">
                            ${user.is_online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}
                        </span>
                    </div>
                </div>
                <div class="user-actions">
                    <button type="button" class="action-btn" onclick="viewUserProfile('${user.username}')" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                        <i class="fas fa-user"></i>
                    </button>
                    <button type="button" class="action-btn" onclick="reportUserFromList('${user.username}')" title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è">
                        üö©
                    </button>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            userDiv.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const username = this.dataset.username;
                
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                document.querySelectorAll('.user-item').forEach(u => u.classList.remove('active'));
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                this.classList.add('active');
                
                currentChatUserId = userId;
                document.getElementById('current-chat-user').textContent = user.display_name || user.username;
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                loadMessages(userId);
            });
            
            usersList.appendChild(userDiv);
        });
    }
    
    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    let typingTimeout;
    
    function setupTypingIndicator() {
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.addEventListener('input', function() {
                if (currentChatUserId) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –Ω–∞—á–∞–ª–µ –ø–µ—á–∞—Ç–∏
                    socket.emit('typing_start', { receiver_id: currentChatUserId });
                    
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
                    clearTimeout(typingTimeout);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
                    typingTimeout = setTimeout(() => {
                        socket.emit('typing_stop', { receiver_id: currentChatUserId });
                    }, 1000);
                }
            });
        }
    }
    
    function showTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.style.display = 'flex';
        }
    }
    
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }
    
    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    function showMessageNotification(data) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${data.sender_name}`, {
                body: data.content,
                icon: '/static/favicon.ico',
                badge: '/static/favicon.ico'
            });
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        const notification = document.createElement('div');
        notification.className = 'message-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-envelope"></i>
                <span>${data.sender_name}: ${data.content}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }
    
    // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
    function setupMobileMenu() {
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const chatSidebar = document.querySelector('.chat-sidebar');
        const isMobile = document.body.classList.contains('device-mobile');
        
        if (isMobile && sidebarToggle && chatSidebar) {
            sidebarToggle.style.display = 'block';
            
            sidebarToggle.addEventListener('click', function() {
                chatSidebar.classList.toggle('active');
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.addEventListener('click', function(e) {
                if (e.target.closest('.user-item')) {
                    chatSidebar.classList.remove('active');
                }
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Å–∞–π–¥–±–∞—Ä–∞
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.chat-sidebar') && !e.target.closest('.sidebar-toggle')) {
                    chatSidebar.classList.remove('active');
                }
            });
        }
    }
    
    // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤, —Ä–µ–∞–∫—Ü–∏–π –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    let currentReplyTo = null;
    
    function replyToMessage(messageId, content) {
        currentReplyTo = messageId;
        document.getElementById('reply-preview').style.display = 'block';
        document.getElementById('reply-text').textContent = content.substring(0, 50) + (content.length > 50 ? '...' : '');
        document.getElementById('message-input').focus();
    }
    
    function cancelReply() {
        currentReplyTo = null;
        document.getElementById('reply-preview').style.display = 'none';
    }
    
    function toggleEmojiPicker() {
        const picker = document.getElementById('emoji-picker');
        picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    }
    
    function addEmoji(emoji) {
        const input = document.getElementById('message-input');
        input.value += emoji;
        input.focus();
        toggleEmojiPicker();
    }
    
    function editMessage(messageId) {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        const messageText = messageDiv.querySelector('.message-text');
        const currentText = messageText.textContent;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentText;
        input.className = 'edit-input';
        
        const saveBtn = document.createElement('button');
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        saveBtn.className = 'btn btn-primary btn-sm';
        saveBtn.onclick = () => saveEditedMessage(messageId, input.value);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
        cancelBtn.className = 'btn btn-secondary btn-sm';
        cancelBtn.onclick = () => cancelEdit(messageDiv, currentText);
        
        messageText.innerHTML = '';
        messageText.appendChild(input);
        messageText.appendChild(saveBtn);
        messageText.appendChild(cancelBtn);
        
        input.focus();
    }
    
    function saveEditedMessage(messageId, newContent) {
        fetch(`/api/message/${messageId}/edit`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: newContent })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                loadMessages(currentChatUserId);
            } else {
                showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏');
            }
        })
        .catch(error => {
            showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏');
        });
    }
    
    function cancelEdit(messageDiv, originalText) {
        const messageText = messageDiv.querySelector('.message-text');
        messageText.textContent = originalText;
    }
    
    function deleteMessage(messageId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            fetch(`/api/message/${messageId}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ delete_for_all: false })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageDiv) {
                        messageDiv.remove();
                    }
                } else {
                    showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            });
        }
    }
    
    function showReactions(messageId) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å —Ä–µ–∞–∫—Ü–∏—è–º–∏
        const reactions = ['üëç', '‚ù§Ô∏è', 'üòÑ', 'üòÆ', 'üò¢', 'üò°'];
        const reactionsHtml = reactions.map(emoji => 
            `<button type="button" class="reaction-btn" onclick="addReaction(${messageId}, '${emoji}')">${emoji}</button>`
        ).join('');
        
        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
        let reactionsPanel = document.getElementById('reactions-panel');
        if (!reactionsPanel) {
            reactionsPanel = document.createElement('div');
            reactionsPanel.id = 'reactions-panel';
            reactionsPanel.className = 'reactions-panel';
            document.body.appendChild(reactionsPanel);
        }
        
        reactionsPanel.innerHTML = reactionsHtml;
        reactionsPanel.style.display = 'block';
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        const rect = messageDiv.getBoundingClientRect();
        reactionsPanel.style.left = rect.left + 'px';
        reactionsPanel.style.top = (rect.top - 60) + 'px';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            reactionsPanel.style.display = 'none';
        }, 3000);
    }
    
    function addReaction(messageId, emoji) {
        fetch(`/api/message/${messageId}/react`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ emoji: emoji })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–π
                loadMessages(currentChatUserId);
            } else {
                showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏');
            }
        })
        .catch(error => {
            showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏');
        });
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π
        document.getElementById('reactions-panel').style.display = 'none';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function viewUserProfile(username) {
        window.open(`/profile/${username}`, '_blank');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∂–∞–ª–æ–±—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
    function reportUserFromChat(messageId, username) {
        if (confirm(`–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @${username}?\n\n–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–∑–¥–∞–Ω–∏—è –∂–∞–ª–æ–±—ã.`)) {
            window.open(`/profile/${username}`, '_blank');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∂–∞–ª–æ–±—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
    function reportUserFromList(username) {
        if (confirm(`–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @${username}?\n\n–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–∑–¥–∞–Ω–∏—è –∂–∞–ª–æ–±—ã.`)) {
            window.open(`/profile/${username}`, '_blank');
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (message && currentChatUserId) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
            socket.emit('send_message', {
                receiver_id: currentChatUserId,
                content: message,
                reply_to_id: currentReplyTo
            });
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –æ—Ç–≤–µ—Ç
            input.value = '';
            cancelReply();
        }
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - Nexa Messenger{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nexa Messenger –ø–æ–¥ —Å–≤–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</p>
    </div>

    <div class="settings-content">
        <form method="POST" class="settings-form">
            <!-- –í–Ω–µ—à–Ω–∏–π –≤–∏–¥ -->
            <div class="settings-section">
                <h3><i class="fas fa-palette"></i> –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                
                <div class="form-group">
                    <label for="theme">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
                    <select id="theme" name="theme" class="form-control">
                        <option value="light" {{ 'selected' if settings.theme == 'light' }}>–°–≤–µ—Ç–ª–∞—è</option>
                        <option value="dark" {{ 'selected' if settings.theme == 'dark' }}>–¢—ë–º–Ω–∞—è</option>
                        <option value="auto" {{ 'selected' if settings.theme == 'auto' }}>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</option>
                    </select>
                    <small>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</small>
                </div>

                <div class="form-group">
                    <label for="language">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
                    <select id="language" name="language" class="form-control">
                        <option value="ru" {{ 'selected' if settings.language == 'ru' }}>–†—É—Å—Å–∫–∏–π</option>
                        <option value="en" {{ 'selected' if settings.language == 'en' }}>English</option>
                    </select>
                    <small>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</small>
                </div>
            </div>

            <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
            <div class="settings-section">
                <h3><i class="fas fa-bell"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="notifications_enabled" 
                               {{ 'checked' if settings.notifications_enabled }}>
                        <span class="checkmark"></span>
                        –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </label>
                    <small>–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</small>
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="sound_enabled" 
                               {{ 'checked' if settings.sound_enabled }}>
                        <span class="checkmark"></span>
                        –ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    </label>
                    <small>–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∑–≤—É–∫ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</small>
                </div>
            </div>

            <!-- –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å -->
            <div class="settings-section">
                <h3><i class="fas fa-shield-alt"></i> –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
                
                <div class="form-group">
                    <label for="privacy_level">–£—Ä–æ–≤–µ–Ω—å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏</label>
                    <select id="privacy_level" name="privacy_level" class="form-control">
                        <option value="public" {{ 'selected' if settings.privacy_level == 'public' }}>–ü—É–±–ª–∏—á–Ω—ã–π</option>
                        <option value="friends" {{ 'selected' if settings.privacy_level == 'friends' }}>–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</option>
                        <option value="private" {{ 'selected' if settings.privacy_level == 'private' }}>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</option>
                    </select>
                    <small>–ö—Ç–æ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ —Å—Ç–∞—Ç—É—Å</small>
                </div>

                <div class="security-info">
                    <div class="security-badge">
                        <i class="fas fa-lock"></i>
                        <span>–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º</span>
                    </div>
                    <p>üîí –í–∞—à–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â–µ–Ω—ã. –ù–∏–∫—Ç–æ –∫—Ä–æ–º–µ –≤–∞—Å –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
                </div>
            </div>

            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="settings-section">
                <h3><i class="fas fa-tools"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>
                
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="auto_save_drafts" 
                               {{ 'checked' if settings.auto_save_drafts }}>
                        <span class="checkmark"></span>
                        –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
                    </label>
                    <small>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</small>
                </div>
                
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="animations_enabled" 
                               {{ 'checked' if settings.animations_enabled }}>
                        <span class="checkmark"></span>
                        –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã
                    </label>
                    <small>–ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ</small>
                </div>
                
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="compact_mode" 
                               {{ 'checked' if settings.compact_mode }}>
                        <span class="checkmark"></span>
                        –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
                    </label>
                    <small>–£–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞</small>
                </div>
            </div>
            
            <!-- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="settings-section">
                <h3><i class="fas fa-user-cog"></i> –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                
                <div class="form-group">
                    <label for="user_status">–°—Ç–∞—Ç—É—Å</label>
                    <select id="user_status" name="user_status" class="form-control">
                        <option value="online">üü¢ –í —Å–µ—Ç–∏</option>
                        <option value="away">üü° –û—Ç–æ—à–µ–ª</option>
                        <option value="busy">üî¥ –ó–∞–Ω—è—Ç</option>
                        <option value="dnd">üö´ –ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å</option>
                    </select>
                    <small>–í–∞—à —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
                </div>
                
                <div class="form-group">
                    <label for="custom_status">–ö–∞—Å—Ç–æ–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å</label>
                    <input type="text" id="custom_status" name="custom_status" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞ —Ä–∞–±–æ—Ç–µ, –í –ø—É—Ç–∏..." 
                           class="form-control" maxlength="100">
                    <small>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º —Å—Ç–∞—Ç—É—Å–µ</small>
                </div>
                
                <div class="form-group">
                    <label for="color_accent">–¶–≤–µ—Ç–æ–≤–æ–π –∞–∫—Ü–µ–Ω—Ç</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="color_accent" name="color_accent" 
                               value="{{ current_user.color_accent or '#00d4ff' }}" 
                               class="color-picker">
                        <span class="color-preview" id="color-preview"></span>
                    </div>
                    <small>–í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–∏–º—ã–π —Ü–≤–µ—Ç –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</small>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ -->
            <div class="settings-section">
                <h3><i class="fas fa-network-wired"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏</h3>
                <div class="connection-info" id="connection-info">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</div>
                </div>
            </div>

            <!-- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ -->
            <div class="settings-section">
                <h3><i class="fas fa-database"></i> –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <div class="backup-info">
                    <p>–í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏ —á–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é.</p>
                    <button type="button" class="btn btn-secondary" onclick="createBackup()">
                        <i class="fas fa-download"></i>
                        –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                    </button>
                    <div id="backup-status" class="backup-status"></div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é
                </a>
            </div>
        </form>
    </div>
</div>

<!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
<div class="tips-container">
    <div class="tips-header">
        <h3><i class="fas fa-lightbulb"></i> –ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h3>
    </div>
    <div class="tips-content" id="tips-content">
        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
    loadTips();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    loadConnectionInfo();
    
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–º—ã
    const themeSelect = document.getElementById('theme');
    themeSelect.addEventListener('change', function() {
        previewTheme(this.value);
    });
});

function loadTips() {
    fetch('/api/tips')
        .then(response => response.json())
        .then(tips => {
            const tipsContent = document.getElementById('tips-content');
            let html = '';
            
            // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            html += '<div class="tip-category"><h4>üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h4><ul>';
            tips.security.forEach(tip => {
                html += `<li>${tip}</li>`;
            });
            html += '</ul></div>';
            
            // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º
            html += '<div class="tip-category"><h4>‚ú® –§—É–Ω–∫—Ü–∏–∏</h4><ul>';
            tips.features.forEach(tip => {
                html += `<li>${tip}</li>`;
            });
            html += '</ul></div>';
            
            // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —á–∞—Ç—É
            html += '<div class="tip-category"><h4>üí¨ –ß–∞—Ç</h4><ul>';
            tips.chat.forEach(tip => {
                html += `<li>${tip}</li>`;
            });
            html += '</ul></div>';
            
            tipsContent.innerHTML = html;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫:', error);
        });
}

function loadConnectionInfo() {
    fetch('/api/connection_info')
        .then(response => response.json())
        .then(info => {
            const connectionInfo = document.getElementById('connection-info');
            connectionInfo.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</div>
                        <div class="info-value">${getDeviceIcon(info.device_type)} ${getDeviceName(info.device_type)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">–ë—Ä–∞—É–∑–µ—Ä:</div>
                        <div class="info-value">${info.browser}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">–ü—Ä–æ—Ç–æ–∫–æ–ª:</div>
                        <div class="info-value">${info.protocol}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">IP –∞–¥—Ä–µ—Å:</div>
                        <div class="info-value">${info.ip_address}</div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:', error);
            document.getElementById('connection-info').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>';
        });
}

function getDeviceIcon(deviceType) {
    switch(deviceType) {
        case 'mobile': return 'üì±';
        case 'tablet': return 'üì±';
        case 'desktop': return 'üíª';
        default: return 'üñ•Ô∏è';
    }
}

function getDeviceName(deviceType) {
    switch(deviceType) {
        case 'mobile': return '–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
        case 'tablet': return '–ü–ª–∞–Ω—à–µ—Ç';
        case 'desktop': return '–ö–æ–º–ø—å—é—Ç–µ—Ä';
        default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
}

function createBackup() {
    const backupStatus = document.getElementById('backup-status');
    backupStatus.innerHTML = '<div class="loading">–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...</div>';
    
    fetch('/api/backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            backupStatus.innerHTML = '<div class="success">‚úÖ ' + data.message + '</div>';
        } else {
            backupStatus.innerHTML = '<div class="error">‚ùå ' + data.message + '</div>';
        }
    })
    .catch(error => {
        backupStatus.innerHTML = '<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏</div>';
        console.error('–û—à–∏–±–∫–∞:', error);
    });
}

function previewTheme(theme) {
    // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã —Ç–µ–º—ã
    document.body.classList.remove('theme-light', 'theme-dark');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å —Ç–µ–º—ã
    if (theme === 'dark') {
        document.body.classList.add('theme-dark');
    } else if (theme === 'light') {
        document.body.classList.add('theme-light');
    }
    // –î–ª—è 'auto' –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–∏—Å—Ç–µ–º–Ω–∞—è —Ç–µ–º–∞
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –ø–∏–∫–µ—Ä–∞
document.addEventListener('DOMContentLoaded', function() {
    const colorPicker = document.getElementById('color_accent');
    const colorPreview = document.getElementById('color-preview');
    
    if (colorPicker && colorPreview) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
        colorPreview.style.backgroundColor = colorPicker.value;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        colorPicker.addEventListener('change', function() {
            colorPreview.style.backgroundColor = this.value;
            updateUserColor(this.value);
        });
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    loadUserSettings();
});

function loadUserSettings() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const statusSelect = document.getElementById('user_status');
    const customStatusInput = document.getElementById('custom_status');
    
    if (statusSelect && customStatusInput) {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ API
        // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
}

function updateUserColor(color) {
    fetch('/api/user/color', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ color: color })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            document.documentElement.style.setProperty('--nexa-primary', color);
            showSuccess('–¶–≤–µ—Ç–æ–≤–æ–π –∞–∫—Ü–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
        } else {
            showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–≤–µ—Ç–∞');
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function updateUserStatus() {
    const status = document.getElementById('user_status').value;
    const customStatus = document.getElementById('custom_status').value;
    
    fetch('/api/user/status', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            status: status, 
            custom_status: customStatus 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
        } else {
            showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        }
    })
    .catch(error => {
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    });
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('user_status');
    const customStatusInput = document.getElementById('custom_status');
    
    if (statusSelect) {
        statusSelect.addEventListener('change', updateUserStatus);
    }
    
    if (customStatusInput) {
        customStatusInput.addEventListener('blur', updateUserStatus);
    }
});
</script>
{% endblock %}
